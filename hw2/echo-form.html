<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Echo Form</title>
</head>
<body>
  <h1>Echo Form Test</h1>

  <form id="echo-form" action="/hw2/python-general-echo.py" method="post" enctype="application/x-www-form-urlencoded">
    <label>
      Language endpoint
      <select id="language">
        <option value="perl">Perl (perl-general-echo.pl)</option>
        <option value="perl_get">Perl (perl-get-echo.pl)</option>
        <option value="perl_post">Perl (perl-post-echo.pl)</option>
        <option value="python">Python (python-general-echo.py)</option>
        <option value="python_get">Python (python-get-echo.py)</option>
        <option value="python_post">Python (python-post-echo.py)</option>
        <option value="php">PHP (php-general-echo.php)</option>
        <option value="php_get">PHP (php-get-echo.php)</option>
        <option value="php_post">PHP (php-post-echo.php)</option>
        <option value="cpp">C++ (general-echo-cpp.cgi)</option>
        <option value="cpp_get">C++ (get-echo-cpp.cgi)</option>
        <option value="cpp_post">C++ (post-echo-cpp.cgi)</option>
      </select>
    </label>
    <br>
    <label>
      Method
      <select id="method">
        <option>GET</option>
        <option>POST</option>
        <option>PUT</option>
        <option>DELETE</option>
      </select>
    </label>
    <br>
    <label>
      Encoding
      <select id="encoding">
        <option value="application/x-www-form-urlencoded">x-www-form-urlencoded</option>
        <option value="application/json">application/json</option>
      </select>
    </label>
    <br>

    <label>
      Field 1
      <input type="text" name="field1" value="Hello" required>
    </label>
    <br>
    <label>
      Field 2
      <input type="text" name="field2" value="World">
    </label>
    <br>
    <label>
      Field 3
      <input type="text" name="field3" value="CSE135">
    </label>
    <br>
    <br>

    <button type="submit">Send</button>
  </form>

  <h2>Preview</h2>
  <pre id="request-preview">(preview)</pre>

  <h2>Response</h2>
  <pre id="response-output">(response will appear here)</pre>


  <h2>Non-JS Version (manual submit)</h2>
  <p>Use this when JavaScript is off. Supports GET/POST with x-www-form-urlencoded only.</p>

  <form id="nojs-form" action="/hw2/python-general-echo.py" method="post" enctype="application/x-www-form-urlencoded" target="nojs-response">
    <label>
      Language endpoint
      <select id="nojs-endpoint" name="endpoint">
        <option value="/hw2/perl-general-echo.pl">Perl (perl-general-echo.pl)</option>
        <option value="/hw2/perl-get-echo.pl">Perl (perl-get-echo.pl)</option>
        <option value="/hw2/perl-post-echo.pl">Perl (perl-post-echo.pl)</option>
        <option value="/hw2/python-general-echo.py">Python (python-general-echo.py)</option>
        <option value="/hw2/python-get-echo.py">Python (python-get-echo.py)</option>
        <option value="/hw2/python-post-echo.py">Python (python-post-echo.py)</option>
        <option value="/hw2/php-general-echo.php">PHP (php-general-echo.php)</option>
        <option value="/hw2/php-get-echo.php">PHP (php-get-echo.php)</option>
        <option value="/hw2/php-post-echo.php">PHP (php-post-echo.php)</option>
        <option value="/hw2/general-echo-cpp.cgi">C++ (general-echo-cpp.cgi)</option>
        <option value="/hw2/get-echo-cpp.cgi">C++ (get-echo-cpp.cgi)</option>
        <option value="/hw2/post-echo-cpp.cgi">C++ (post-echo-cpp.cgi)</option>
      </select>
    </label>
    <br>
    <label>
      Method
      <select id="nojs-method" name="__method">
        <option>GET</option>
        <option>POST</option>
      </select>
    </label>
    <br>
    <label>
      Field 1
      <input type="text" name="field1" value="Hello">
    </label>
    <br>
    <label>
      Field 2
      <input type="text" name="field2" value="World">
    </label>
    <br>
    <label>
      Field 3
      <input type="text" name="field3" value="CSE135">
    </label>
    <br><br>
    <button type="submit">Send</button>
  </form>

  <p>Non-JS responses will load in this tab after submit.</p>

  <script>
    const form = document.getElementById("echo-form");
    const languageSelect = document.getElementById("language");
    const methodSelect = document.getElementById("method");
    const encodingSelect = document.getElementById("encoding");
    const requestPreview = document.getElementById("request-preview");
    const responseOutput = document.getElementById("response-output");
    const noJsForm = document.getElementById("nojs-form");
    const noJsEndpoint = document.getElementById("nojs-endpoint");
    const noJsMethod = document.getElementById("nojs-method");

    const endpoints = {
      perl: "/hw2/perl-general-echo.pl",
      perl_get: "/hw2/perl-get-echo.pl",
      perl_post: "/hw2/perl-post-echo.pl",
      python: "/hw2/python-general-echo.py",
      python_get: "/hw2/python-get-echo.py",
      python_post: "/hw2/python-post-echo.py",
      php: "/hw2/php-general-echo.php",
      php_get: "/hw2/php-get-echo.php",
      php_post: "/hw2/php-post-echo.php",
      cpp: "/hw2/general-echo-cpp.cgi",
      cpp_get: "/hw2/get-echo-cpp.cgi",
      cpp_post: "/hw2/post-echo-cpp.cgi"
    };

    function serializeFormData() {
      const data = new FormData(form);
      const payload = {};
      data.forEach((value, key) => {
        if (payload[key]) {
          payload[key] = [].concat(payload[key], value);
        } else {
          payload[key] = value;
        }
      });
      return payload;
    }

    function updateFormAttributes() {
      const endpoint = endpoints[languageSelect.value];
      const method = methodSelect.value;
      const encoding = encodingSelect.value;
      form.action = endpoint;
      form.method = method.toLowerCase();
      form.enctype = encoding;
    }

    function updateNoJsFormAttributes() {
      if (!noJsForm) return;
      noJsForm.action = noJsEndpoint.value;
      noJsForm.method = noJsMethod.value.toLowerCase();
    }

    function buildPreview() {
      const endpoint = endpoints[languageSelect.value];
      const method = methodSelect.value;
      const encoding = encodingSelect.value;
      const payload = serializeFormData();
      updateFormAttributes();
      const bodyPreview = encoding === "application/json"
        ? JSON.stringify(payload, null, 2)
        : new URLSearchParams(payload).toString();

      const lines = [
        `${method} ${endpoint}`,
        `Content-Type: ${encoding}`,
        "",
        method === "GET" ? `?${bodyPreview}` : bodyPreview
      ];

      requestPreview.textContent = lines.join("\n");
    }

    async function submitRequest(event) {
      event.preventDefault();
      const endpoint = endpoints[languageSelect.value];
      const method = methodSelect.value;
      const encoding = encodingSelect.value;
      const payload = serializeFormData();
      updateFormAttributes();

      let url = endpoint;
      let body;
      const headers = {};

      if (encoding === "application/json") {
        body = JSON.stringify(payload);
        headers["Content-Type"] = "application/json";
      } else {
        const params = new URLSearchParams(payload);
        body = params.toString();
        headers["Content-Type"] = "application/x-www-form-urlencoded";
      }

      if (method === "GET") {
        const query = body ? `?${body}` : "";
        url = `${endpoint}${query}`;
        body = undefined;
      }

      try {
        responseOutput.textContent = "Sending request...";
        const response = await fetch(url, {
          method,
          headers,
          body: method === "GET" ? undefined : body
        });
        const text = await response.text();
        responseOutput.textContent = text;

      } catch (error) {
        responseOutput.textContent = `Request failed: ${error}`;
      }
    }

    [languageSelect, methodSelect, encodingSelect].forEach((select) => {
      select.addEventListener("change", buildPreview);
    });

    buildPreview();
    updateNoJsFormAttributes();
    form.addEventListener("submit", submitRequest);
    if (noJsEndpoint && noJsMethod) {
      noJsEndpoint.addEventListener("change", updateNoJsFormAttributes);
      noJsMethod.addEventListener("change", updateNoJsFormAttributes);
    }
  </script>
</body>
</html>
